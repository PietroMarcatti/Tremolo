name: Build Audio Plugin

on: [push, workflow_dispatch]

jobs:
  build_mac:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install JUCE
      run: git clone https://github.com/juce-framework/JUCE.git --depth 1 --branch master

    - name: Configure CMake
      run: cmake -B build -DJUCE_BUILD_EXTRAS=ON

    - name: Build
      # This compiles the code (Release mode)
      run: cmake --build build --config Release

    - name: Zip the VST3 (Auto-Detect)
      run: |
        # 1. Find the .vst3 file anywhere in the build folder
        # This command looks for any folder ending in .vst3
        VST3_PATH=$(find build -name "*.vst3" | head -n 1)
        
        if [ -z "$VST3_PATH" ]; then
          echo "ERROR: Could not find any .vst3 file! The build might have failed silently."
          exit 1
        fi
        
        echo "Found plugin at: $VST3_PATH"
        
        # 2. Go to the folder containing the plugin
        cd "$(dirname "$VST3_PATH")"
        
        # 3. Zip it using the actual filename found
        # We use the name of the folder found (e.g., Tremolo.vst3)
        PLUGIN_NAME=$(basename "$VST3_PATH")
        zip -r Tremolo_Mac.zip "$PLUGIN_NAME"
        
        # 4. Move the zip to the main workspace so the next step can find it
        mv Tremolo_Mac.zip "$GITHUB_WORKSPACE/"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Tremolo-Mac-VST3
        path: Tremolo_Mac.zip